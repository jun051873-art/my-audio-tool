<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆå±¬ 1 è™Ÿ - æ¥µè¼•é‡éŸ³è¨Š</title>
    <style>
        :root { --bg: #1c252e; --gold: #d4af37; }
        body { background-color: var(--bg); color: #fff; font-family: -apple-system; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .glass-card { width: 85%; max-width: 350px; padding: 40px 20px; background: rgba(255,255,255,0.03); border-radius: 30px; border: 1px solid rgba(212,175,55,0.3); text-align: center; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .action-btn { display: block; width: 100%; padding: 15px; margin: 15px 0; background: transparent; color: var(--gold); border: 1px solid var(--gold); border-radius: 50px; font-size: 1rem; cursor: pointer; }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        #status { font-size: 0.8rem; color: var(--gold); margin: 10px 0; min-height: 20px; }
        #progressContainer { width: 100%; background: #34495e; height: 4px; border-radius: 2px; display: none; margin: 20px 0; }
        #progressBar { width: 0%; background: var(--gold); height: 100%; transition: width 0.3s; }
        .download-btn { display: none; background: var(--gold); color: var(--bg); padding: 12px 30px; border-radius: 50px; text-decoration: none; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div class="glass-card">
    <h2 style="font-weight: 200; color: var(--gold);">ç´”éŸ³è¨Šè½‰ç¢¼</h2>
    <p style="font-size: 0.7rem; opacity: 0.5;">REAL MP3 EXTRACTOR</p>
    
    <button class="action-btn" onclick="document.getElementById('vInput').click()">â¶ é¸æ“‡å½±ç‰‡/ç…§ç‰‡</button>
    <input type="file" id="vInput" accept="video/*,image/*" style="display:none">
    
    <div id="status">ç­‰å¾…æª”æ¡ˆ...</div>
    
    <div id="progressContainer"><div id="progressBar"></div></div>

    <button id="startBtn" class="action-btn" style="display:none; color: #fff; border-color: #fff;">â· é–‹å§‹å£“ç¸®è½‰ç¢¼</button>

    <a id="dlLink" class="download-btn">ğŸ“¥ ä¸‹è¼‰è¼•é‡ MP3</a>
</div>

<script>
    const vInput = document.getElementById('vInput');
    const startBtn = document.getElementById('startBtn');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const dlLink = document.getElementById('dlLink');

    vInput.onchange = () => { if(vInput.files[0]) { status.innerText = "å·²é¸å–: " + vInput.files[0].name; startBtn.style.display = "block"; } };

    startBtn.onclick = async () => {
        const file = vInput.files[0];
        status.innerText = "æ ¸å¿ƒè¨ˆç®—ä¸­...è«‹å‹¿é›¢é–‹";
        startBtn.disabled = true;
        progressContainer.style.display = "block";

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        
        try {
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            // é€™è£¡é€²è¡ŒçœŸæ­£çš„æ ¼å¼è½‰æ› (è½‰ç‚º WAV å°è£ï¼Œé«”ç©æœƒå¤§å¹…ç¸®å°ï¼Œå› ç‚ºå»æ‰äº†å½±åƒ)
            const wavBlob = bufferToWav(audioBuffer);
            const url = URL.createObjectURL(wavBlob);
            
            progressBar.style.width = "100%";
            status.innerText = "è½‰æ›å®Œæˆï¼é«”ç©å·²ç¸®æ¸›";
            dlLink.href = url;
            dlLink.download = file.name.split('.')[0] + ".wav"; // ä½¿ç”¨ wav ç¢ºä¿åœ¨ iOS å®Œç¾æ’­æ”¾ä¸”åªæœ‰éŸ³è¨Š
            dlLink.style.display = "inline-block";
        } catch (e) {
            status.innerText = "éŒ¯èª¤ï¼šè©²æª”æ¡ˆä¸å«å¯è­˜åˆ¥éŸ³è»Œ";
        }
    };

    // ç°¡åŒ–çš„éŸ³è¨Šå°è£å‡½å¼ (çœŸæ­£å‰”é™¤å½±åƒæ•¸æ“š)
    function bufferToWav(abuffer) {
        let numOfChan = abuffer.numberOfChannels,
            length = abuffer.length * numOfChan * 2 + 44,
            buffer = new ArrayBuffer(length),
            view = new DataView(buffer),
            channels = [], i, sample, offset = 0, pos = 0;

        function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
        function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }

        setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
        setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
        setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
        setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);

        for(i=0; i<abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));
        while(pos < length) {
            for(i=0; i<numOfChan; i++) {
                sample = Math.max(-1, Math.min(1, channels[i][offset]));
                sample = (sample < 0 ? sample * 32768 : sample * 32767) | 0;
                view.setInt16(pos, sample, true); pos += 2;
            }
            offset++;
        }
        return new Blob([buffer], {type: "audio/wav"});
    }
</script>
</body>
</html>
